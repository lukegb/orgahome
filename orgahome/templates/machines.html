{% extends "base.html" %}
{% block title %}EMF{% endblock %}
{% block content %}
    <main class="container">
        <div class="glass-card glass-card-no-hover machines-card">
            <table class="machines-table">
                <thead>
                    <tr>
                        <th class="machine-toggle-cell"></th>
                        <th>Hostname</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Distro</th>
                        <th>Last contact</th>
                        <th>Last status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for machine in combined_info %}
                        <tr class="machine-row">
                            <td>
                                <button class="machine-toggle-btn" aria-label="Toggle details">â–¶</button>
                            </td>
                            <td>{{ machine.inventory.certname.removesuffix(".emfcamp.org") }}</td>
                            <td class="{% if not machine.emf_info.location or machine.emf_info.location == " [unset]" %}text-muted{% endif %}">
                                {{ machine.emf_info.location | default("[unset]") }}
                            </td>
                            <td class="{% if not machine.emf_info.description or machine.emf_info.description == " [unset]" %}text-muted{% endif %}">
                                {{ machine.emf_info.description | default("[unset]") }}
                            </td>
                            <td class="distro-cell"
                                data-distro="{{ machine.inventory.facts.os.distro.id }}"
                                data-major="{{ machine.inventory.facts.os.distro.release.major }}"
                                data-minor="{{ machine.inventory.facts.os.distro.release.minor }}"
                                data-codename="{{ machine.inventory.facts.os.distro.codename }}">
                                {{ machine.inventory.facts.os.distro.id }} {{ machine.inventory.facts.os.distro.release.full }}
                                ({{ machine.inventory.facts.os.distro.codename }})
                            </td>
                            <td>
                                {{ machine.node.report_timestamp | from_iso | friendly_date }}
                                {% if machine.catalog_commit_hash %}
                                    <div class="catalog-version">
                                        <a href="https://github.com/emfcamp/puppet/commit/{{ machine.catalog_commit_hash }}"
                                           target="_blank"
                                           class="catalog-version-link"
                                           style="--catalog-color: {{ machine.catalog.version | color_hash }}">
                                            {{ machine.catalog.version }}
                                        </a>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="machines-status"
                                data-status="{{ machine.node.latest_report_status }}">
                                {{ machine.node.latest_report_status }}
                            </td>
                        </tr>
                        <tr class="machine-details-row">
                            <td colspan="7">
                                <div class="machine-details-content">
                                    {% if machine.websites %}
                                        <div class="detail-section">
                                            <h4>Websites</h4>
                                            <ul>
                                                {% for site in machine.websites %}
                                                    <li>
                                                        <a href="https://{{ site }}"
                                                           target="_blank"
                                                           rel="noopener noreferrer"
                                                           class="website-link">{{ site }}</a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    <div class="detail-section">
                                        <h4>Hardware</h4>
                                        <ul>
                                            <li>CPU: {{ machine.inventory.facts.processors.count }} cores</li>
                                            <li>RAM: {{ machine.inventory.facts.memory.system.total }}</li>
                                        </ul>
                                    </div>
                                    <div class="detail-section">
                                        <h4>System</h4>
                                        <ul>
                                            <li>Architecture: {{ machine.inventory.facts.os.architecture }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
{% endblock %}
{% block scripts %}<script src="{{ static_url_for('main.js') }}"></script>{% endblock %}
